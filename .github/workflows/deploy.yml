name: Deploy Worker

on:
  # push:
  #   branches: [ main ]
  # 可选：手动触发
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Run Build Script
        run: |
          chmod +x ./build.sh  # 确保脚本可执行
          ./build.sh           # 执行构建脚本
      
      - name: Verify Build Output
        run: |
          echo "检查构建产物..."
          if [ ! -f "app.js" ]; then
            echo "❌ 错误：app.js 未生成"
            exit 1
          fi
          echo "✅ app.js 生成成功"
          echo "文件大小: $(wc -c < app.js) 字节"
      
      - name: Install Wrangler
        run: npm install -g wrangler
        
      - name: Deploy to Cloudflare Workers
        run: wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}